name: Conditional Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check if deployment is enabled
        id: check_deploy
        run: |
          if [ -f "deploy.config.json" ]; then
            SHOULD_DEPLOY=$(jq -r '.deploy.enabled // false' deploy.config.json)
            SUBDOMAIN=$(jq -r '.deploy.subdomain // ""' deploy.config.json)
            APP_PATH=$(jq -r '.deploy.app_path // "/var/www/app"' deploy.config.json)
            APP_NAME=$(jq -r '.deploy.app_name // "app"' deploy.config.json)
            
            echo "enabled=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
            echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
            echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT
            echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Hetzner
        if: steps.check_deploy.outputs.enabled == 'true'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            APP_PATH="${{ steps.check_deploy.outputs.app_path }}"
            APP_NAME="${{ steps.check_deploy.outputs.app_name }}"
            SUBDOMAIN="${{ steps.check_deploy.outputs.subdomain }}"
            DOMAIN="${{ secrets.CLOUDFLARE_DOMAIN }}"
            
            # Create app directory if it doesn't exist
            if [ ! -d "$APP_PATH" ]; then
              echo "ðŸ“ Creating directory $APP_PATH"
              sudo mkdir -p "$APP_PATH"
              sudo chown -R $USER:$USER "$APP_PATH"
            fi
            
            # Clone or pull repository
            if [ ! -d "$APP_PATH/.git" ]; then
              echo "ðŸ“¦ Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git "$APP_PATH"
            else
              echo "ðŸ”„ Updating repository..."
              cd "$APP_PATH"
              git pull origin main
            fi
            
            # Install dependencies and build
            cd "$APP_PATH"
            echo "ðŸ“¦ Installing dependencies..."
            npm install
            echo "ðŸ—ï¸ Building application..."
            npm run build
            
            # Create Nginx config
            NGINX_CONFIG="/etc/nginx/sites-available/$APP_NAME"
            echo "âš™ï¸ Configuring Nginx..."

            # Create config in temp file first (no sudo needed)
            cat > /tmp/nginx-config.tmp <<EOF
            server {
                listen 80;
                server_name ${SUBDOMAIN}.${DOMAIN};

                root ${APP_PATH}/dist;
                index index.html;

                location / {
                    try_files \$uri \$uri/ /index.html;
                }

                location /api {
                    proxy_pass https://react-fast-pizza-api.jonas.io;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }

                # Cache static assets
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            EOF

            echo "ðŸ“„ Generated Nginx config:"
            cat /tmp/nginx-config.tmp

            # Move to nginx directory with sudo
            sudo cp /tmp/nginx-config.tmp "$NGINX_CONFIG"

            # Enable the site
            sudo ln -sf "$NGINX_CONFIG" /etc/nginx/sites-enabled/

            # Test and reload Nginx
            echo "ðŸ§ª Testing Nginx configuration..."
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "âœ… Nginx configuration applied successfully"
            else
              echo "âŒ Nginx configuration test failed"
              echo "ðŸ“‹ Checking for syntax errors..."
              sudo nginx -t 2>&1
              exit 1
            fi


      - name: Check if DNS record exists
        if: steps.check_deploy.outputs.enabled == 'true'
        id: check_dns
        run: |
          SUBDOMAIN="${{ steps.check_deploy.outputs.subdomain }}"
          RESPONSE=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records?name=${SUBDOMAIN}.${{ secrets.CLOUDFLARE_DOMAIN }}" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")
          
          RECORD_ID=$(echo $RESPONSE | jq -r '.result[0].id // ""')
          echo "record_id=$RECORD_ID" >> $GITHUB_OUTPUT

      - name: Create or Update Cloudflare DNS Record
        if: steps.check_deploy.outputs.enabled == 'true'
        run: |
          SUBDOMAIN="${{ steps.check_deploy.outputs.subdomain }}"
          RECORD_ID="${{ steps.check_dns.outputs.record_id }}"
          
          if [ -z "$RECORD_ID" ]; then
            # Create new record
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{
                "type": "A",
                "name": "'"$SUBDOMAIN"'",
                "content": "${{ secrets.HETZNER_SERVER_IP }}",
                "ttl": 1,
                "proxied": true
              }'
            echo "âœ… Created DNS record for $SUBDOMAIN"
          else
            # Update existing record
            curl -X PUT "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records/$RECORD_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data '{
                "type": "A",
                "name": "'"$SUBDOMAIN"'",
                "content": "${{ secrets.HETZNER_SERVER_IP }}",
                "ttl": 1,
                "proxied": true
              }'
            echo "âœ… Updated DNS record for $SUBDOMAIN"
          fi
